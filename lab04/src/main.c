// Julia Gong
// 9/27/25
// This is the main module that includes note frequencies for songs, timers, and PWM signals

#include "STM32L432KC_FLASH.h"
#include "STM32L432KC_GPIO.h"
#include "STM32L432KC_RCC.h"
#include "STM32L432KC_TIM16.h"
#include "STM32L432KC_TIM6.h"

// Pitch in Hz, duration in ms
const int fur_elise_notes[][2] = {
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{416,	125},
{494,	125},
{523,	250},
{  0,	125},
{330,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{523,	125},
{494,	125},
{440,	250},
{  0,	125},
{494,	125},
{523,	125},
{587,	125},
{659,	375},
{392,	125},
{699,	125},
{659,	125},
{587,	375},
{349,	125},
{659,	125},
{587,	125},
{523,	375},
{330,	125},
{587,	125},
{523,	125},
{494,	250},
{  0,	125},
{330,	125},
{659,	125},
{  0,	250},
{659,	125},
{1319,	125},
{  0,	250},
{623,	125},
{659,	125},
{  0,	250},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{416,	125},
{494,	125},
{523,	250},
{  0,	125},
{330,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{523,	125},
{494,	125},
{440,	500},
{  0,	0}};

// whole notes are 2 seconds
const int song[][2] = {
// measure 1
{392, 750}, 
{330, 250},
{330, 250},
{294, 500},
{392, 750}, 
 //measure 2
{330, 250},
{330, 500},
{330, 250},
{294, 250},
{392, 750}, 
// measure 3
{330, 500},
{330, 500},
{294, 250},
{392, 500},
// measure 4
{392, 250},
{330, 250},
{330, 500},
{330, 250},
{294, 250},
{350, 250},
// measure 5
{294, 500},
{294, 500},
{294, 250},
{262, 250}, 
{330, 750}, 
// measure 6
{262, 500},
{262, 500},
{262, 250},
{233, 500},
// measure 7
{0, 500},
{262, 1500},
// measure 8
{262, 2000},
// repeat
// measure 1
{392, 750}, 
{330, 250},
{330, 250},
{294, 500},
{392, 750}, 
 //measure 2
{330, 250},
{330, 500},
{330, 250},
{294, 250},
{392, 750}, 
// measure 3
{330, 500},
{330, 500},
{294, 250},
{392, 500},
// measure 4
{392, 250},
{330, 250},
{330, 500},
{330, 250},
{294, 250},
{350, 250},
// measure 5
{294, 500},
{294, 500},
{294, 250},
{262, 250}, 
{330, 750}, 
// measure 6
{262, 500},
{262, 500},
{262, 250},
{233, 500},
// measure 7
{0, 500},
{262, 1500},
// measure 8
{262, 2000},
{0, 0}
};


int main(void) {
    // initializations
    configureFlash();
    configureClock();
    init_delay();
    init_PWM();

    // setting up RCC
    RCC->APB1ENR1 |= (1 << 4); // enabling TIM6 clk
    RCC->AHB2ENR |= (1 << 0); // enabling GPIOA clk
    // set GPIO PA6 to peripheral (10)
    pinMode(6, 2);
    // 0b1110 into bits 27:24, for pin 6, setting pin 6 to AF14
    GPIO->AFRL &=  ~(0xF << (6 * 4)); 
    GPIO->AFRL |=  (14 << (6 * 4)); 

    int len_fur_elise = sizeof(fur_elise_notes) / sizeof(fur_elise_notes[0]);
        for (int i = 0; i < len_fur_elise; i++) {
            if (fur_elise_notes[i][1] == 0) {
                PWM_freq(0);
            }
            PWM_freq(fur_elise_notes[i][0]);
            delay(fur_elise_notes[i][1]);
        }
    
    delay(3000);

    int len_song = sizeof(song) / sizeof(song[0]);
        for (int i = 0; i < len_song; i++) {
            if (song[i][1] == 0) {
                PWM_freq(0);
            }
            PWM_freq(song[i][0]);
            delay(song[i][1]);
        }

}   
